# SPDX-FileCopyrightText: 2025 hexaTune LLC
# SPDX-License-Identifier: MIT

default_platform(:ios)

# --- Helper methods ----------------------------------------------------------

def repo_root
  # The repository root is one level above the fastlane directory
  File.expand_path("..", __dir__)
end

def resolve_path(p)
  # If APP_DIR is not absolute, resolve it relative to the repository root
  return p if p.start_with?("/")
  File.expand_path(p, repo_root)
end

def detect_app_dir
  # 1) Manual override â€” if APP_DIR is provided via environment variable, use it
  from_env = ENV['APP_DIR']
  if from_env
    candidate = resolve_path(from_env)
    UI.user_error!("APP_DIR='#{from_env}' provided but directory not found: #{candidate}") unless Dir.exist?(candidate)
    return candidate
  end

  # 2) Automatic detection â€” try common Flutter directory names
  candidates = %w[hexagenapp hexaGenApp app .]
  hit = candidates.find do |d|
    full = File.expand_path(d, repo_root)
    File.exist?(File.join(full, "pubspec.yaml"))
  end
  hit ||= candidates.find do |d|
    full = File.expand_path(d, repo_root)
    Dir.exist?(File.join(full, "ios"))
  end

  UI.user_error!("Flutter project directory not found. Tried: #{candidates.join(', ')}") unless hit
  File.expand_path(hit, repo_root)
end

# --- Main lane ---------------------------------------------------------------

platform :ios do
  desc "Build the Flutter IPA and upload it to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']

    team_id        = "3B6JLK5JN9"
    app_identifier = "com.hexatune.hexagenapp"

    # 1) Ä°mzalama materyallerini getir (Apple Distribution + App Store profile)
    match(
      type: "appstore",
      app_identifier: app_identifier,
      team_id: team_id,
      readonly: true
    )

    # 2) Xcode'u otomatik imzalamaya al (Release â†’ Apple Distribution)
    automatic_code_signing(
      path: "ios/Runner.xcodeproj",
      use_automatic_signing: true,
      team_id: team_id
    )

    # 3) Flutter derleme
    app_dir = detect_app_dir
    UI.message("Using Flutter app directory: #{app_dir}")

    Dir.chdir(app_dir) do
      sh("flutter --version")
      sh("flutter pub get")

      if File.directory?("ios") && File.exist?(File.join("ios", "Podfile"))
        Dir.chdir("ios") do
          sh("pod repo update")
          sh("pod install")
        end
      end

      build_number = ENV['BUILD_NUMBER'] || Time.now.strftime("%Y%m%d%H%M")
      sh("flutter build ipa --release --build-number=#{build_number} --export-options-plist=ios/exportOptions.plist")
    end

    # 4) IPA bul ve TestFlight'a yÃ¼kle
    app_dir = detect_app_dir
    ipa = Dir[File.join(app_dir, "build/ios/ipa/*.ipa")].first
    UI.user_error!("IPA not found at #{File.join(app_dir, 'build/ios/ipa/*.ipa')}") unless ipa

    api_key_path = ENV['APP_STORE_CONNECT_API_KEY_PATH']
    UI.user_error!("APP_STORE_CONNECT_API_KEY_PATH is missing or invalid") unless api_key_path && File.exist?(api_key_path)

    upload_to_testflight(
      ipa: ipa,
      api_key_path: api_key_path,
      skip_waiting_for_build_processing: true,
      notify_external_testers: false,
      groups: []
    )

    UI.success("ðŸŽ‰ TestFlight upload triggered successfully!")
  end
end
