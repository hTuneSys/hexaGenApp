# SPDX-FileCopyrightText: 2025 hexaTune LLC
# SPDX-License-Identifier: MIT

default_platform(:ios)

# --- Helper methods ----------------------------------------------------------

def repo_root
  File.expand_path("..", __dir__)
end

def resolve_path(p)
  return p if p.start_with?("/")
  File.expand_path(p, repo_root)
end

def detect_app_dir
  from_env = ENV['APP_DIR']
  if from_env
    candidate = resolve_path(from_env)
    UI.user_error!("APP_DIR='#{from_env}' provided but directory not found: #{candidate}") unless Dir.exist?(candidate)
    return candidate
  end

  candidates = %w[hexagenapp hexaGenApp app .]
  hit = candidates.find do |d|
    full = File.expand_path(d, repo_root)
    File.exist?(File.join(full, "pubspec.yaml"))
  end
  hit ||= candidates.find do |d|
    full = File.expand_path(d, repo_root)
    Dir.exist?(File.join(full, "ios"))
  end

  UI.user_error!("Flutter project directory not found. Tried: #{candidates.join(', ')}") unless hit
  File.expand_path(hit, repo_root)
end

def ensure_export_options!(app_dir)
  plist_path = File.join(app_dir, "ios", "exportOptions.plist")
  UI.user_error!("exportOptions.plist not found at #{plist_path}") unless File.exist?(plist_path)
  plist_path
end

# --- Main lane ---------------------------------------------------------------

platform :ios do
  desc "Build the Flutter IPA and upload it to TestFlight"
  lane :beta do
    app_dir = detect_app_dir
    UI.message("Using Flutter app directory: #{app_dir}")

    export_plist = ensure_export_options!(app_dir)

    Dir.chdir(app_dir) do
      sh("flutter --version")
      sh("flutter pub get")

      if File.directory?("ios") && File.exist?(File.join("ios", "Podfile"))
        Dir.chdir("ios") do
          sh("pod repo update")
          sh("pod install")
        end
        Dir.chdir(app_dir) # return to project root
      end

      build_number = ENV['BUILD_NUMBER'] || Time.now.strftime("%Y%m%d%H%M")
      UI.message("Using build number: #{build_number}")

      # Force manual signing with distribution certificate/provisioning
      sh(%Q[
        flutter build ipa --release --build-number=#{build_number} \
        --export-options-plist=#{export_plist}
      ])
    end

    app_dir = detect_app_dir
    ipa = Dir[File.join(app_dir, "build/ios/ipa/*.ipa")].first
    UI.user_error!("IPA not found at #{File.join(app_dir, 'build/ios/ipa/*.ipa')}") unless ipa
    UI.message("IPA found: #{ipa}")

    api_key_path = ENV['APP_STORE_CONNECT_API_KEY_PATH']
    UI.user_error!("APP_STORE_CONNECT_API_KEY_PATH is missing or invalid") unless api_key_path && File.exist?(api_key_path)
    UI.message("Using App Store Connect API key at: #{api_key_path}")

    upload_to_testflight(
      ipa: ipa,
      api_key_path: api_key_path,
      skip_waiting_for_build_processing: true,
      notify_external_testers: false,
      groups: []
    )

    UI.success("ðŸŽ‰ TestFlight upload triggered successfully!")
  end
end

